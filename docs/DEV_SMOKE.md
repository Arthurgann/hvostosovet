# DEV SMOKE ‚Äî –±—ã—Å—Ç—Ä–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ backend API

–≠—Ç–æ—Ç —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥:
- –ª–æ–∫–∞–ª—å–Ω—ã–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –¥–µ–ø–ª–æ–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ backend

–¶–µ–ª—å: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ API –∂–∏–≤–æ–µ –∏ –Ω–µ —Å–ª–æ–º–∞–Ω–æ, –∞ —Ä–µ–∂–∏–º—ã –∏ —Å–µ—Å—Å–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

–ö–æ–Ω—Ç—Ä–∞–∫—Ç API: —Å–º. docs/API.md

---

## 1) –ó–∞–ø—É—Å–∫ backend –ª–æ–∫–∞–ª—å–Ω–æ (Windows)

–û—Ç–∫—Ä–æ–π PowerShell / Terminal.

```powershell
cd backend
.\.venv\Scripts\Activate.ps1
uvicorn app.main:app --reload
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- —Å–µ—Ä–≤–µ—Ä —Å—Ç–∞—Ä—Ç—É–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å `Uvicorn running on http://127.0.0.1:8000`

---

## 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ health-check

```powershell
curl http://127.0.0.1:8000/v1/health
```

–û–∂–∏–¥–∞–µ–º–æ:
```json
{
  "ok": true,
  "version": "...",
  "db": "ok"
}
```

---

## 3) –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (/v1/me)

```powershell
$env:BOT_BACKEND_TOKEN="devtoken123"
curl -H "Authorization: Bearer $env:BOT_BACKEND_TOKEN" http://127.0.0.1:8000/v1/me
```

–û–∂–∏–¥–∞–µ–º–æ:
- HTTP 200
- –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ / —Ç–æ–∫–µ–Ω–µ

---

## 4) –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ endpoint (/v1/chat/ask)

```powershell
$rid = [guid]::NewGuid().ToString()
$headers = @{
  Authorization = "Bearer $env:BOT_BACKEND_TOKEN"
  "X-Request-Id" = $rid
}
$body = @{
  user = @{ telegram_user_id = 123456 }
  text = "–¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å"
} | ConvertTo-Json -Depth 5

Invoke-RestMethod `
  -Method Post `
  -Uri "http://127.0.0.1:8000/v1/chat/ask" `
  -Headers $headers `
  -ContentType "application/json" `
  -Body $body
```

–û–∂–∏–¥–∞–µ–º–æ:
- HTTP 200
- –æ—Ç–≤–µ—Ç –æ—Ç backend
- –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

---

## 4.1) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ (mode) –∏ session_context

### –®–∞–≥ 1 ‚Äî —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ –Ω–∞ `care`

```powershell
$rid = [guid]::NewGuid().ToString()
$headers = @{ Authorization = "Bearer $env:BOT_BACKEND_TOKEN"; "X-Request-Id" = $rid }
$body = @{
  user = @{ telegram_user_id = 123456 }
  text = "–¢–µ—Å—Ç: —Ä–µ–∂–∏–º care"
  mode = "care"
} | ConvertTo-Json -Depth 5

Invoke-RestMethod -Method Post -Uri "http://127.0.0.1:8000/v1/chat/ask" -Headers $headers -ContentType "application/json" -Body $body
```

–û–∂–∏–¥–∞–µ–º–æ:
- HTTP 200
- –≤ –ª–æ–≥–∞—Ö backend: `active_mode=care`

### –®–∞–≥ 2 ‚Äî –∑–∞–ø—Ä–æ—Å –±–µ–∑ mode (—Ä–µ–∂–∏–º –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è)

```powershell
$rid = [guid]::NewGuid().ToString()
$headers = @{ Authorization = "Bearer $env:BOT_BACKEND_TOKEN"; "X-Request-Id" = $rid }
$body = @{
  user = @{ telegram_user_id = 123456 }
  text = "–¢–µ—Å—Ç: –±–µ–∑ mode, –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è care"
} | ConvertTo-Json -Depth 5

Invoke-RestMethod -Method Post -Uri "http://127.0.0.1:8000/v1/chat/ask" -Headers $headers -ContentType "application/json" -Body $body
```

–û–∂–∏–¥–∞–µ–º–æ:
- HTTP 200
- —Ä–µ–∂–∏–º –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–µ—Å—Å–∏—è (TTL –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è)

---

## 5) –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–æ–≤–µ—Ä—å:
- `.env` –≤ backend (DATABASE_URL, BOT_BACKEND_TOKEN)
- —á—Ç–æ —Ç–æ–∫–µ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –∂–¥—ë—Ç backend
- —á—Ç–æ Supabase –¥–æ—Å—Ç—É–ø–µ–Ω
- —á—Ç–æ –∫–∞–∂–¥—ã–π POST —Å–æ–¥–µ—Ä–∂–∏—Ç `X-Request-Id`
- –ª–æ–≥–∏ backend (`CHAT_PROMPT`, `session_context`)

---

## –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏

- health OK
- /v1/me OK
- /v1/chat/ask OK
- mode / session_context OK

–ï—Å–ª–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî backend –≥–æ—Ç–æ–≤.


### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Free / Pro –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ–ª–µ `users.plan` –≤ Supabase.

–î–ª—è smoke-—Ç–µ—Å—Ç–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä—É—á–Ω—É—é –º–µ–Ω—è—Ç—å `plan`:

- `free` ‚Äî –ø–æ–≤–µ–¥–µ–Ω–∏–µ Free (–ª–∏–º–∏—Ç—ã, –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è pet.profile)
- `pro` ‚Äî –ø–æ–≤–µ–¥–µ–Ω–∏–µ Pro (–¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –ø–∏—Ç–æ–º—Ü–∞)

–ü—Ä–∏–º–µ—Ä SQL:

```sql
update users set plan='pro' where telegram_user_id=123456;
update users set plan='free' where telegram_user_id=123456;

Backend –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FORCE_PRO.
FORCE_PRO –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤ telegram-bot –¥–ª—è UX-—Ç–µ—Å—Ç–æ–≤.





## 6) Telegram-–±–æ—Ç ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Telegram-–±–æ—Ç –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç backend API
(–ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ UX, –∫–Ω–æ–ø–∫–∞—Ö, –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫).

### 6.1) –ó–∞–ø—É—Å–∫ Telegram-–±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ (Windows)

```powershell
cd telegram-bot
.\.venv\Scripts\Activate.ps1
python main.py
```

–û–∂–∏–¥–∞–µ–º–æ:
- –±–æ—Ç —Å—Ç–∞—Ä—Ç—É–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- –≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç tracebacks
- –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ backend –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

---

### 6.2) Happy-path (–æ–±—ã—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å)

–î–µ–π—Å—Ç–≤–∏—è:
- –æ—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram
- –∑–∞–¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å

–û–∂–∏–¥–∞–µ–º–æ:
- –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–º
- –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:
  - `üÜì –ü–ª–∞–Ω: Free ¬∑ –û—Å—Ç–∞–ª–æ—Å—å —Å–µ–≥–æ–¥–Ω—è: N`
  - –∏–ª–∏ `üíé –ü–ª–∞–Ω: Pro`

---

### 6.3) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ Free (HTTP 429)

–î–µ–π—Å—Ç–≤–∏—è:
- –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ Free

–û–∂–∏–¥–∞–µ–º–æ:
- –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:
  - `üÜì –õ–∏–º–∏—Ç Free –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω. –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞.`
- –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ¬´–û—Ñ–æ—Ä–º–∏—Ç—å Pro¬ª
- —Å—Ç—Ä–æ–∫–∞ `–°–±—Ä–æ—Å: ...` –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

---

### 6.4) –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–∫–∏ upsell

–î–µ–π—Å—Ç–≤–∏—è:
- –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É ¬´–û—Ñ–æ—Ä–º–∏—Ç—å Pro¬ª

–û–∂–∏–¥–∞–µ–º–æ:
- –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞–≥–ª—É—à–∫–æ–π
- –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç

---

### 6.5) Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

–î–µ–π—Å—Ç–≤–∏—è:
- –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å backend
- –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –≤ –±–æ—Ç–µ

–û–∂–∏–¥–∞–µ–º–æ:
- –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
  - `‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –ø–∞—Ä—É –º–∏–Ω—É—Ç.`

---

### 6.6) Dirty-guard –¥–ª—è Pro-–∞–Ω–∫–µ—Ç—ã

–î–µ–π—Å—Ç–≤–∏—è:
- –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–∑–æ–≤–æ–µ –ø–æ–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–º—è) –∏ –Ω–∞–∂–∞—Ç—å "‚úÖ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ–ø—Ä–æ—Å—É"
- –≤ guard –≤—ã–±—Ä–∞—Ç—å –ø–æ –æ—á–µ—Ä–µ–¥–∏:
  - "‚Ü©Ô∏è –û—Å—Ç–∞—Ç—å—Å—è"
  - "üö´ –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å"
  - "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
- –∏–∑–º–µ–Ω–∏—Ç—å health_note –∏ —Å–Ω–æ–≤–∞ –Ω–∞–∂–∞—Ç—å "‚úÖ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ–ø—Ä–æ—Å—É"
- –¥–≤–∞–∂–¥—ã –ø–æ–¥—Ä—è–¥ –Ω–∞–∂–∞—Ç—å "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –≤ guard
- –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ dirty=False (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

–û–∂–∏–¥–∞–µ–º–æ:
- –ø–æ—è–≤–ª—è–µ—Ç—Å—è guard —Å 3 –∫–Ω–æ–ø–∫–∞–º–∏
- "‚Ü©Ô∏è –û—Å—Ç–∞—Ç—å—Å—è" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –ø–æ—Å—Ç-–º–µ–Ω—é
- "üö´ –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å" —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –≤–æ–ø—Ä–æ—Å—É / –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç pending_question
- "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –≤–æ–ø—Ä–æ—Å—É / –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç pending_question
- –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ "üíæ" –Ω–µ –¥–µ–ª–∞–µ—Ç –¥–≤–æ–π–Ω–æ–π save (–µ—Å—Ç—å is_profile_saving –∑–∞—â–∏—Ç–∞)
- –ø—Ä–∏ dirty=False –ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤–æ–ø—Ä–æ—Å—É —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ guard

---

## –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ (Telegram-–±–æ—Ç)

- –∑–∞–ø—É—Å–∫ OK
- happy-path OK
- –ª–∏–º–∏—Ç Free / 429 OK
- upsell-–∫–Ω–æ–ø–∫–∞ OK
- –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ backend OK

–ï—Å–ª–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî Telegram-–±–æ—Ç –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç backend —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
