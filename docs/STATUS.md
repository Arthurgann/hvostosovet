# STATUS — Хвостосовет (январь 2026)

Этот файл — **источник истины** о том, что в проекте уже реализовано и стабилизировано.
Используется для онбординга новых чатов / разработчиков и чтобы не предлагать повторно сделанные вещи.

---

## Реализовано и стабильно

### Pro профиль питомца
- Явное сохранение профиля через `POST /v1/pets/active/save`.
- PATCH / merge семантика: частичные обновления **не затирают** профиль.
- Сохранение **не вызывает LLM** и **не пишет в sessions**.
- Защита от двойного сохранения (`profile_saving`).
- Dirty-guard при выходе с несохранёнными изменениями:
  - варианты: **сохранить / не сохранять / остаться**.

### UX ⭐ «Мой питомец»
- Экран ⭐ «Мой питомец» с **summary профиля**.
- Краткий (short) / полный (full) вид профиля.
- Переключение short/full через `edit_message_text`
  с fallback на `reply()` при невозможности редактирования.
- Возврат из Pro post-меню (**«Вернуться к вопросу»**) всегда ведёт на:
  **⭐ «Мой питомец» (short)**.
- Dirty-discard (**«Не сохранять»**) также возвращает на ⭐ «Мой питомец» (short).

### Pro анкета питомца
- Базовые шаги: вид → имя → возраст → пол → порода/animal_kind → вес (опц.).
- Шаг имени:
  - поддерживает кнопку **«Пропустить»**;
  - поддерживает текстовый ввод «пропустить».
- Поддержка питомцев типа **`other`**:
  - используется поле `animal_kind`;
  - слово «Другое» в UI не показывается при наличии вида.
- Опциональные контекстные блоки профиля:
  - **Особенности здоровья** (категории + текст);
  - **Прививки и профилактика** (vaccines / parasites);
  - **Важное о питомце** (free text);
  - **Условия жизни и питание** (lifestyle).
- Контекстные блоки:
  - не обязательны;
  - не блокируют основной сценарий;
  - могут заполняться и редактироваться в любой момент;
  - хранятся в `pets.profile` и обновляются с PATCH / merge-семантикой.


### Remembered‑UX (Pro)
- Активный питомец хранится в backend (Supabase `pets`).
- При вопросе:
  - **Pro + minimal `{type}`** → профиль подтягивается из БД;
  - **Free** → профиль из БД **никогда** не подгружается.
- Контракт источника профиля:
  `request > db (Pro only) > none`.
- Все заполненные блоки профиля питомца
  (базовые и контекстные)
  учитываются backend при формировании prompt для LLM.


 ### Pro Vision (загрузка и анализ фото)

- Реализована загрузка **фото питомца для Pro-пользователей** (Telegram):
  - изображение скачивается из Telegram;
  - сжимается (Pillow);
  - кодируется в base64 и отправляется в backend (Variant A).
- Free / Pro поведение:
  - **Free** → backend возвращает `402 pro_required`, бот показывает upsell;
  - **Pro** → фото + текст обрабатываются vision-моделью.
- Backend:
  - при наличии изображения (`attachments`) принудительно выбирается `policy=pro_vision`;
  - provider = `openrouter`;
  - модель берётся из `OPENROUTER_VISION_MODEL`;
  - добавлен guard `503 openrouter_not_configured`, если ключ не задан.
- LLM:
  - используется multimodal формат сообщений:
    `[{type: "text"}, {type: "image_url"}]`;
  - формат изображения: `data:image/jpeg;base64,...`.
- Prompts:
  - добавлен `VISION_PREFIX`;
  - явно разрешает анализ изображений;
  - запрещает ответы вида «я не вижу изображение»;
  - применён ко всем режимам (`care`, `vaccines`, `emergency`).
- Диагностика:
  - backend логи `LLM_MESSAGES_IMAGE`, `LLM_HTTP`;
  - в ответ `/v1/chat/ask` добавлены `meta.llm_provider`, `meta.llm_model`, `meta.policy_name`.

Примечания:
- `qwen/qwen-vl-plus` не работает с Variant A (data URL) через OpenRouter;
- рабочая модель по умолчанию: `openai/gpt-4o-mini` (через OpenRouter);
- архитектура подготовлена для Variant B (`/media/init`, https URL).


### LLM / Prompts — текущее состояние

- Промпты режимов `care`, `vaccines`, `emergency` считаются **стабилизированными**.
- Используется версия **v2.2-balanced**:
  - структура ответа носит **рекомендательный**, а не обязательный характер;
  - длина ответа адаптируется моделью к контексту диалога;
  - уточняющие ответы обычно занимают 2–3 абзаца, без жёстких требований.
- Автотесты (`prompt-eval`) используются как **сигнальная сетка**, а не критерий качества.
- Любые изменения промптов допускаются **только после подтверждения проблемы в живых диалогах**.

#### Форматирование ответов (Telegram)
- `parse_mode=Markdown` **осознанно не используется**:
  - в реальных диалогах артефакты `**` не воспроизводятся;
  - визуальная читабельность признана достаточной.
- Возможность включения `parse_mode` зафиксирована как **отложенное решение**,
  возвращаемся к нему только при реальных UX-проблемах.
 

### Архитектура
- Telegram‑бот = **тонкий клиент** (UX + state).
- Backend = **единый мозг** (логика, лимиты, LLM, память).
- Вопросы → `/v1/chat/ask`.
- Сохранение профиля → `/v1/pets/active/save`.
- Free / Pro определяется **только** через `users.plan` в БД.
- `FORCE_PRO` не используется в стабильном сценарии.

---

## Осознанно НЕ делаем сейчас
- Автосохранение анкеты без кнопки.
- Историю изменений профиля питомца.
- Web / PWA UI (подготовка есть, реализация позже).
- Платёжную систему и подписки.


## изменения

- Pro Vision: добавлена защита от списания квоты при отказе vision-модели;
  ошибки `vision_not_processed` обрабатываются отдельно с понятным UX в боте.
- UX-дополнение:
  - экран ℹ️ «Как это работает» кратко описывает возможность анализа фото в Pro;
  - при ответах с изображениями бот показывает подсказку
    по качеству фото (крупно, в фокусе, хорошее освещение).



---

## Репозиторий и ветки (январь 2026)

- Актуальное состояние проекта зафиксировано в ветке `main`.
- Ветка `backend-mvp-v0` сохранена как историческая (MVP-период),
  в данный момент отстаёт от `main` и не используется для разработки.
- Вся дальнейшая разработка ведётся от `main`
  (feature/* → merge → delete).

---

## Как использовать файл
- В новом чате:  
  **«Контекст проекта зафиксирован в `docs/STATUS.md` — использовать как source of truth.»**
- Для деталей и истории изменений см. `CHANGELOG.md`.
- Для навигации по коду и потокам см. docs/FILEMAP.md.
- Для контракта API см. docs/API.md.
