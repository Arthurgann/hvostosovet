## Запуск backend (Windows)
```powershell
cd backend
.\.venv\Scripts\Activate.ps1
uvicorn app.main:app --reload

## Запуск Telegram-бота (Windows)
```powershell
cd telegram-bot
.\.venv\Scripts\Activate.ps1
python main.py

## 2026-01-03
### Backend — TTL-сессии (Free)

- Реализованы TTL-сессии для Free-пользователей:
  временная память диалога хранится в таблице `sessions`.
- В `session_context` сохраняется хвост диалога в формате:
  `turns: [{q, a}, …]`.
- Контекст активен, пока `expires_at > now()`; при каждом новом сообщении TTL продлевается.
- Количество хранимых пар вопрос-ответ ограничено `SESSION_MAX_TURNS`.
- Перед вызовом LLM backend формирует контекстный префикс из предыдущих turn’ов.
- Новый turn (`q/a`) сохраняется **только после успешного ответа LLM**.

Параметры:
- `SESSION_TTL_MIN` — время жизни активной сессии (в минутах).
- `SESSION_MAX_TURNS` — максимальное количество хранимых пар `q/a`.

Проверка:
- Отправить вопрос A и уточнение B (с новым `X-Request-Id`).
- Убедиться, что ответ на B учитывает контекст A.
- Проверить наличие `q/a` в `sessions.session_context` через SQL (`jsonb_path_exists`).


## 2026-01-03
### База данных / Backend

- Добавлено ограничение `CHECK` для `users.plan` — допускаются только значения `'free'` и `'pro'`.
- Обновлён внешний ключ `sessions.user_id → users.id` с `ON DELETE CASCADE`
  (при удалении пользователя его сессии удаляются автоматически).
- Зафиксировано поведение Supabase UI:
  превью `jsonb` может обрезаться и визуально не показывать все поля.
  Для корректной проверки `session_context` следует использовать SQL:
  `jsonb_path_exists(...)` и оператор `#>>`.

Проверка:
- Проверить ограничения через `pg_constraint` для таблиц `users` и `sessions`.
- Проверить наличие `q/a` в `sessions.session_context` через SQL, а не через Table Editor.

## 2026-01-03
### Telegram-бот

- Исправлено: второй вопрос пользователя не отправлялся в backend.
- Причина: профиль очищался сразу после ответа.
- Теперь профиль сохраняется, а бот переводится в состояние ожидания следующего вопроса.
- Добавлены управляемые debug-логи через переменную окружения BOT_DEBUG.
- Исправлен фильтр Pyrogram для текстовых сообщений (исключение команд).

Проверка:
- Задать вопрос → получить ответ → задать второй вопрос → backend получает оба запроса.
- BOT_DEBUG=1 — логи включены, BOT_DEBUG=0 — логи выключены.

