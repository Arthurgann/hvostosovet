from pyrogram import Client, filters
from pyrogram.types import Message, CallbackQuery
from pyrogram.enums import ChatAction
from collections import defaultdict
import asyncio
import openai
import config

# OpenAI –∫–ª–∏–µ–Ω—Ç
client = openai.OpenAI(api_key=config.OPENAI_API_KEY)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–Ω–∫–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_profiles = defaultdict(dict)

# üì¶ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
prompts_by_context = {
    "care": """–í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π. –í–∞—à —Å—Ç–∏–ª—å ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π. –í—ã –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ ¬´–í—ã¬ª, –≤—Å–µ–≥–¥–∞ —Å –∑–∞–±–æ—Ç–æ–π –∏ —Ç–µ–ø–ª–æ—Ç–æ–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞—Ç–∏–ª—Å—è —Å –≤–æ–ø—Ä–æ—Å–æ–º –ø–æ —Ç–µ–º–µ —É—Ö–æ–¥–∞ –∏ –ø–∏—Ç–∞–Ω–∏—è, –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∞–Ω–∫–µ—Ç—É –æ –ø–∏—Ç–æ–º—Ü–µ: –ø–æ—Ä–æ–¥–∞, –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, —É—Å–ª–æ–≤–∏—è –∂–∏–∑–Ω–∏ –∏ —Ç.–¥.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —á—Ç–æ–±—ã –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ì–æ–≤–æ—Ä–∏—Ç–µ —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω—è–ª: —ç—Ç–æ –Ω–µ –æ–±—â–∏–π —Å–æ–≤–µ—Ç –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –Ω–µ–º—É –∏ –µ–≥–æ –ø–∏—Ç–æ–º—Ü—É.

–£–ø–æ–º–∏–Ω–∞–π—Ç–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ—Ä–æ–¥—ã, –≤–æ–∑—Ä–∞—Å—Ç–∞, –ø–æ–ª–∞ –∏ —É—Å–ª–æ–≤–∏–π –∂–∏–∑–Ω–∏, –µ—Å–ª–∏ —ç—Ç–æ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ. –î–∞–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ–¥ —ç—Ç–æ—Ç —Å–ª—É—á–∞–π. –°—Ç–∏–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á—ë—Ç–∫–∏–º, –ø–æ–Ω—è—Ç–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º.

‚ùó –ù–µ —Å–ø–µ—à–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä—É, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∫–æ—Ä–º–ª–µ–Ω–∏—è, –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤, —à–µ—Ä—Å—Ç–∏ –∏ –≥–∏–≥–∏–µ–Ω—ã. –ü–æ–º–æ–≥–∏—Ç–µ —Å–æ–≤–µ—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–æ–º–∞. –£–ø–æ–º—è–Ω–∏—Ç–µ –≤–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ—á—å –æ —Ç—Ä–µ–≤–æ–∂–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö, –∏ —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ü–µ.

–ß—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–¥–∞–π—Ç–µ 1‚Äì2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞.

–ü—Ä–∏–º–µ—Ä –∞–Ω–∫–µ—Ç—ã:
–¢–∏–ø –ø–∏—Ç–æ–º—Ü–∞: dog
–û–ø–∏—Å–∞–Ω–∏–µ: –õ–∞–±—Ä–∞–¥–æ—Ä, 6 –º–µ—Å—è—Ü–µ–≤, –º–∞–ª—å—á–∏–∫, –∂–∏–≤—ë—Ç –≤ —á–∞—Å—Ç–Ω–æ–º –¥–æ–º–µ, –∞–∫—Ç–∏–≤–Ω—ã–π, –≥—É–ª—è–µ—Ç 3 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å.

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
–ö–∞–∫ –º–æ–ª–æ–¥–æ–π –ª–∞–±—Ä–∞–¥–æ—Ä, –≤–∞—à –ø—ë—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–∑–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞. –í —ç—Ç–æ–º –≤–æ–∑—Ä–∞—Å—Ç–µ –≤–∞–∂–Ω–æ –∫–æ—Ä–º–∏—Ç—å –µ–≥–æ 3‚Äì4 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ—Ä–º–æ–º –¥–ª—è —â–µ–Ω–∫–æ–≤ –∫—Ä—É–ø–Ω—ã—Ö –ø–æ—Ä–æ–¥. –õ–∞–±—Ä–∞–¥–æ—Ä—ã —Å–∫–ª–æ–Ω–Ω—ã –∫ –Ω–∞–±–æ—Ä—É –≤–µ—Å–∞, –ø–æ—ç—Ç–æ–º—É —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–æ—Ä—Ü–∏—è–º–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —É–ª–∏—Ü–µ ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –¥–æ–∂–¥–ª–∏–≤—É—é –ø–æ–≥–æ–¥—É ‚Äî –ø–æ—Å–ª–µ –ø—Ä–æ–≥—É–ª–∫–∏ –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–æ—Ç–∏—Ä–∞—Ç—å –ª–∞–ø—ã –∏ –æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ–¥—É—à–µ—á–∫–∏.

–ê –≤—ã —É–∂–µ –≤—ã–±—Ä–∞–ª–∏ –º–∏—Å–∫—É —Å –ø–æ–¥—Å—Ç–∞–≤–∫–æ–π? –ò –∫–∞–∫ –æ–Ω —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Ä–∞—Å—á—ë—Å—ã–≤–∞–Ω–∏–µ —à–µ—Ä—Å—Ç–∏?
""",

    "health": """–í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º. –í—ã –≤–µ–¥—ë—Ç–µ –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∏ –æ–±—â–∞–µ—Ç–µ—Å—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–∞ ¬´–í—ã¬ª, —Å —Ç—ë–ø–ª–æ–π –∏ —Å–ø–æ–∫–æ–π–Ω–æ–π –ø–æ–¥–∞—á–µ–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞—Ç–∏–ª—Å—è –∑–∞ —Å–æ–≤–µ—Ç–æ–º –ø–æ —Ç–µ–º–µ –ø—Ä–∏–≤–∏–≤–æ–∫, –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ –∏ –≥–∏–≥–∏–µ–Ω—ã. –û–Ω —Ç–∞–∫–∂–µ –∑–∞–ø–æ–ª–Ω–∏–ª –∞–Ω–∫–µ—Ç—É –æ —Å–≤–æ—ë–º –ø–∏—Ç–æ–º—Ü–µ: –ø–æ—Ä–æ–¥—É, –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª –∏ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏.

–û—Å–Ω–æ–≤—ã–≤–∞–π—Ç–µ —Å–≤–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–µ –¥–∞–≤–∞–π—Ç–µ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã ‚Äî –ø—É—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç —É–º–µ—Å—Ç–Ω—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ. –ï—Å–ª–∏ –ø–∏—Ç–æ–º–µ—Ü –º–æ–ª–æ–¥–æ–π ‚Äî –¥–∞–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∞–∫—Ü–∏–Ω–∞—Ü–∏–∏ –∏ –∑–∞—â–∏—Ç–µ –æ—Ç –ø–∞—Ä–∞–∑–∏—Ç–æ–≤ –¥–ª—è —â–µ–Ω–∫–æ–≤/–∫–æ—Ç—è—Ç. –ï—Å–ª–∏ –≤–∑—Ä–æ—Å–ª—ã–π ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –∏ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –≤–∞–∂–Ω–æ–µ.

–¢–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–æ–ª–Ω–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–∏–≤–∏–≤–æ–∫, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç –±–ª–æ—Ö –∏ –∫–ª–µ—â–µ–π, –≥–∏–≥–∏–µ–Ω–∞ —É—à–µ–π –∏ –∑—É–±–æ–≤, –∫–æ–≥—Ç–∏, –≥–ª–∞–∑–∞.

–ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä—É ‚Äî —Ü–µ–ª—å: –ø–æ–º–æ—á—å –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ –∏ –¥–æ–º–∞—à–Ω–µ–≥–æ —É—Ö–æ–¥–∞. –ö –≤—Ä–∞—á—É –Ω–∞–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ç—Ä–µ–≤–æ–∂–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–ª–∞–Ω–æ–≤–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞.

–ü—Ä–∏–º–µ—Ä –∞–Ω–∫–µ—Ç—ã:
–¢–∏–ø –ø–∏—Ç–æ–º—Ü–∞: cat
–û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–π–Ω-–∫—É–Ω, 2 –≥–æ–¥–∞, –¥–µ–≤–æ—á–∫–∞, –∂–∏–≤—ë—Ç –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —É–ª–∏—Ü—É, —Å—Ç–µ—Ä–∏–ª–∏–∑–æ–≤–∞–Ω–∞.

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
–î–ª—è –≤–∑—Ä–æ—Å–ª–æ–π –∫–æ—à–∫–∏, –∂–∏–≤—É—â–µ–π –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏, –∞–∫—Ç—É–∞–ª—å–Ω–∞ –µ–∂–µ–≥–æ–¥–Ω–∞—è –≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—è –æ—Ç –≤–∏—Ä—É—Å–Ω—ã—Ö –∏–Ω—Ñ–µ–∫—Ü–∏–π, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —É–ª–∏—Ü—É. –¢–∞–∫–∂–µ –≤–∞–∂–Ω–æ –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–æ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –æ—Ç –≥–ª–∏—Å—Ç–æ–≤ ‚Äî —Ä–∞–∑ –≤ 3 –º–µ—Å—è—Ü–∞. –ú–µ–π–Ω-–∫—É–Ω—ã –∏–º–µ—é—Ç —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é –∑—É–±–Ω–æ–≥–æ –Ω–∞–ª—ë—Ç–∞, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ª–∞–∫–æ–º—Å—Ç–≤–∞ –∏–ª–∏ –ø–∞—Å—Ç—É –¥–ª—è —É—Ö–æ–¥–∞ –∑–∞ –∑—É–±–∞–º–∏.

–ê –∫–æ–≥–¥–∞ –≤—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –µ—ë –æ—Ç –±–ª–æ—Ö –∏ –∫–ª–µ—â–µ–π? –ò –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–∏ –æ–Ω–∞ —Å–ø–æ–∫–æ–π–Ω–æ –æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —É—à–∏?
""",

    "emergency": """–í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –≤ –æ–Ω–ª–∞–π–Ω-—Ñ–æ—Ä–º–∞—Ç–µ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞—Ç–∏–ª—Å—è —Å —Ç—Ä–µ–≤–æ–∂–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–º –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∫—Ä–∞—Ç–∫—É—é –∞–Ω–∫–µ—Ç—É ‚Äî –ø–æ—Ä–æ–¥—É, –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª –∏ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏ –ø–∏—Ç–æ–º—Ü–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.

–û—á–µ–Ω—å –≤–∞–∂–Ω–æ: –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å —Å–ø–æ–∫–æ–π–Ω—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –ø—É–≥–∞–π—Ç–µ –µ–≥–æ. –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è, –æ–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ —Å—Ç–æ–∏—Ç –ø–æ–Ω–∞–±–ª—é–¥–∞—Ç—å, –∏ –∫–∞–∫–∏–µ –º–µ—Ä—ã –º–æ–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å –¥–æ–º–∞. –ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –∏ —É—Å–ø–æ–∫–æ–π—Ç–µ, –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ.

–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä—É —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏. –¢–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ü–µ, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∏–º–ø—Ç–æ–º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–≤–æ–∂–Ω—ã, —Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ ¬´–≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –ª—É—á—à–µ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ª–∏—á–Ω–æ¬ª.

–ü—Ä–∏–º–µ—Ä –∞–Ω–∫–µ—Ç—ã:
–¢–∏–ø –ø–∏—Ç–æ–º—Ü–∞: dog
–û–ø–∏—Å–∞–Ω–∏–µ: –®–ø–∏—Ü, 5 –ª–µ—Ç, –º–∞–ª—å—á–∏–∫, –∂–∏–≤—ë—Ç –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ, –ø–∏—Ç–∞–µ—Ç—Å—è –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–π –ø–∏—â–µ–π, –∞–∫—Ç–∏–≤–Ω—ã–π.

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
–ï—Å–ª–∏ —É —à–ø–∏—Ü–∞ –ø–æ—è–≤–∏–ª—Å—è –∫–∞—à–µ–ª—å –∏ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≥—É–ª–∫–∏ ‚Äî —É —ç—Ç–æ–π –ø–æ—Ä–æ–¥—ã —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –≥–æ—Ä–ª–æ. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –µ—Å—Ç—å –ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è, –∞–ø–∞—Ç–∏—è –∏–ª–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –∞–ø–ø–µ—Ç–∏—Ç–∞. –ï—Å–ª–∏ –∫–∞—à–µ–ª—å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 2‚Äì3 –¥–Ω–µ–π –∏–ª–∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è ‚Äî —Ç–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –∫–ª–∏–Ω–∏–∫—É.

–ê –∫–æ–≥–¥–∞ –≤—ã —ç—Ç–æ –≤–ø–µ—Ä–≤—ã–µ –∑–∞–º–µ—Ç–∏–ª–∏? –û–Ω –∫–æ–Ω—Ç–∞–∫—Ç–∏—Ä–æ–≤–∞–ª —Å –¥—Ä—É–≥–∏–º–∏ —Å–æ–±–∞–∫–∞–º–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è?
"""
}

def setup_question_handlers(app: Client):

    @app.on_callback_query(filters.regex("^(dog|cat|other)_(emergency|care|health)$"))
    async def start_unified_form(client_tg: Client, callback_query: CallbackQuery):
        await callback_query.answer()
        user_id = callback_query.from_user.id
        pet_type, context = callback_query.data.split("_")

        user_profiles[user_id] = {
            "type": pet_type,
            "context": context,
            "step": "basic_info"
        }

        if pet_type == "dog":
            example = "–¢–∞–∫—Å–∞, 3 –≥–æ–¥–∞, –¥–µ–≤–æ—á–∫–∞, –∂–∏–≤—ë—Ç –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ, –≥—É–ª—è–µ—Ç 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å, —Å–∫–ª–æ–Ω–Ω–∞ –∫ –ø–æ–ª–Ω–æ—Ç–µ."
        elif pet_type == "cat":
            example = "–ë—Ä–∏—Ç–∞–Ω—Å–∫–∞—è –∫–æ—Ä–æ—Ç–∫–æ—à—ë—Ä—Å—Ç–Ω–∞—è, 4 –≥–æ–¥–∞, –∫–æ—Ç, –∂–∏–≤—ë—Ç –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ —É–ª–∏—Ü—É, —Å—Ç–µ—Ä–∏–ª–∏–∑–æ–≤–∞–Ω."
        else:
            example = "–•–æ—Ä—ë–∫, 1.5 –≥–æ–¥–∞, —Å–∞–º–µ—Ü, –∂–∏–≤—ë—Ç –≤ –≤–æ–ª—å–µ—Ä–µ, –∞–∫—Ç–∏–≤–Ω—ã–π, –ø–∏—Ç–∞–µ—Ç—Å—è —Å—É—Ö–∏–º –∫–æ—Ä–º–æ–º."

        # –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ
        if context == "care":
            intro = (
                "üêæ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —É—Ö–æ–¥ ‚Äî –æ—Å–Ω–æ–≤–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤–∞—à–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞!**\n\n"
                "–Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ—Ä–º–ª–µ–Ω–∏—é, –≥–∏–≥–∏–µ–Ω–µ, —É—Ö–æ–¥—É –∑–∞ —à–µ—Ä—Å—Ç—å—é, –∫–æ–≥—Ç—è–º–∏ –∏ –¥—Ä—É–≥–∏–º ‚Äî "
                "—Å —É—á—ë—Ç–æ–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –≤–∞—à–µ–≥–æ –ª—é–±–∏–º—Ü–∞.\n\n"
            )
        elif context == "health":
            intro = (
                "üõ° **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∏–≤–∏–≤–∫–∏, –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –∏ –±–∞–∑–æ–≤–∞—è –≥–∏–≥–∏–µ–Ω–∞ ‚Äî –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å –∑–∞–±–æ—Ç—ã –æ –∑–¥–æ—Ä–æ–≤—å–µ –ø–∏—Ç–æ–º—Ü–∞.**\n\n"
                "–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –∫–∞–∫–∏–µ –ø—Ä–∏–≤–∏–≤–∫–∏ –Ω—É–∂–Ω—ã, –∫–∞–∫ —É—Ö–∞–∂–∏–≤–∞—Ç—å –∑–∞ –∑—É–±–∞–º–∏ –∏ —É—à–∞–º–∏, "
                "–∫–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–∞—Ä–∞–∑–∏—Ç–æ–≤, –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.\n\n"
            )
        else:
            intro = ""

        await callback_query.message.edit_text(
            intro +
            "üóì –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—Ç–æ–º—Ü–µ: –ø–æ—Ä–æ–¥–∞, –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏\n\n"
            f"–ü—Ä–∏–º–µ—Ä: {example}",
            disable_web_page_preview=True
        )

    @app.on_message(filters.text & filters.private)
    async def collect_unified_info(client_tg: Client, message: Message):
        user_id = message.from_user.id
        profile = user_profiles.get(user_id)

        if not profile:
            return

        if profile["step"] == "done":
            await message.reply("‚åõ –Ø —É–∂–µ –≥–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶")
            return

        step = profile.get("step")

        if step == "basic_info":
            profile["basic_info"] = message.text.strip()
            profile["step"] = "question"

            if profile["context"] == "care":
                await message.reply(
                    "üìù –ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:\n\n"
                    "–ü—Ä–∏–º–µ—Ä: –ø–æ–¥–±–æ—Ä –∫–æ—Ä–º–∞, —Ä–µ–∂–∏–º –∫–æ—Ä–º–ª–µ–Ω–∏—è, —É—Ö–æ–¥ –∑–∞ —à–µ—Ä—Å—Ç—å—é, –∫–æ–≥—Ç—è–º–∏, —É—à–∞–º–∏, –≥–∏–≥–∏–µ–Ω–∞, "
                    "–≤—ã–±–æ—Ä –º–∏—Å–æ–∫, –ª–µ–∂–∞–Ω–æ–∫ –∏ –¥—Ä—É–≥–∏—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤."
                )

            elif profile["context"] == "health":
                await message.reply(
                    "üìù –ù–∞–ø–∏—à–∏—Ç–µ, –æ —á—ë–º –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å:\n\n"
                    "–ü—Ä–∏–º–µ—Ä: –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–≤–∏–≤–æ–∫, –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –≥–ª–∏—Å—Ç–æ–≤, —É—Ö–æ–¥ –∑–∞ –∑—É–±–∞–º–∏, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç –±–ª–æ—Ö –∏ –∫–ª–µ—â–µ–π, "
                    "—Å—Ç—Ä–∏–∂–∫–∞ –∫–æ–≥—Ç–µ–π, —á–∏—Å—Ç–∫–∞ —É—à–µ–π, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–ª–∞–∑."
                )

            else:
                await message.reply(
                    "üí¨ –û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç –í–∞—à–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞, –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å:"
                )

        elif step == "question":
            profile["question"] = message.text.strip()
            profile["step"] = "done"

            summary = f"""üìã –ê–Ω–∫–µ—Ç–∞:
–¢–∏–ø –ø–∏—Ç–æ–º—Ü–∞: {profile['type']}
–û–ø–∏—Å–∞–Ω–∏–µ: {profile['basic_info']}
–í–æ–ø—Ä–æ—Å: {profile['question']}"""

            await message.reply("‚åõ –í–∞—à –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

            await client_tg.send_chat_action(message.chat.id, ChatAction.TYPING)

            try:
                system_prompt = prompts_by_context.get(profile["context"], "")
                response = await asyncio.to_thread(
                    client.chat.completions.create,
                    model=config.OPENAI_MODEL,
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": summary}
                    ],
                    temperature=0.7,
                    max_tokens=800
                )

                answer = response.choices[0].message.content
                await message.reply(f"üß† –û—Ç–≤–µ—Ç:\n\n{answer}")

            except Exception as e:
                await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI:\n{e}")

            user_profiles.pop(user_id, None)
